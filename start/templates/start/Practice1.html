{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}{% endblock %}

{% block content %}
<script>
  // expose meta from session to the page
  window.interpreter_title   = {{ session.vars.interpreter_title|json }};
  window.interpreter_choices = {{ session.vars.interpreter_choices|json }};
</script>

<div id="app">
  {% verbatim %}
  <h3 class="mb-3">{{ title }}</h3>

  <div v-if="main_text" v-html="main_text" class="mb-3"></div>

  <div class="text-center my-3" v-if="image_path">
    <img :src="image_path" alt="" :width="500">
  </div>

  <form @submit.prevent="checkChoices">
    <table class="table">
      <thead>
        <tr>
          <th scope="col">{{ interpreter_title }}</th>
          <th v-for="(opt, i) in options" :key="i" scope="col">{{ opt }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, idx) in rows" :key="idx">
          <td>{{ row.name }}</td>
          <td v-for="(opt, i) in options" :key="i">
            <input type="radio" :name="'r'+idx" v-model="row.choice" :value="i" @change="resetError">
          </td>
        </tr>
      </tbody>
    </table>

    <button :disabled="!allChoicesMade" type="button" @click="checkChoices" class="btn btn-primary">Next</button>
    <p v-if="error" class="alert alert-danger my-3">Please check your answers.</p>
  </form>
  {% endverbatim %}
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
  data() {
    // Build row labels from interpreter choices (one row per choice)
    const options = window.interpreter_choices && window.interpreter_choices.length
        ? ['Yes','No']  // columns (change if you really need more than Yes/No)
        : ['Yes','No'];

    // For your current study you want a fixed set of rows from interpreter_choices
    const rows = (window.interpreter_choices || []).map(n => ({ name: n, choice: null }));

    return {
      image_path: js_vars.settings.full_image_path,
      title: js_vars.settings.title || 'Practice',
      main_text: js_vars.settings.main_text || '',
      interpreter_title: window.interpreter_title || 'Interpretation',
      options,
      rows,
      correctAnswers: (js_vars.settings.right_answer || []).map(x => {
        // treat '1' as Yes(0), '0' as No(1) if needed; adjust mapping as your key requires
        // Here we assume: 1 => Yes (index 0), 0 => No (index 1)
        const v = String(x).trim();
        return v === '1' ? 0 : 1;
      }),
      error: false,
    }
  },
  methods: {
    resetError(){ this.error = false; },
    checkChoices(){
      if (this.correctAnswers.length !== this.rows.length) { this.error=true; return; }
      const ok = this.rows.every((r, i) => r.choice === this.correctAnswers[i]);
      this.error = !ok;
      if (!this.error) { document.getElementById('form').submit(); }
    }
  },
  computed: {
    allChoicesMade(){ return this.rows.every(r => r.choice !== null); }
  }
});
app.mount('#app');
</script>
{% endblock %}
