{% extends "otree/Page.html" %}
{% load otree static %}

{% block content %}

<script>
  // expose server vars
  window.suffixes       = {{ session.vars.suffixes|json }};
  window.allowedValues  = {{ session.vars.allowed_values|json }};
  window.page_settings  = {{ settings|json }};
</script>

<style>
  [v-cloak] { display: none; }
  .input-group { max-width: fit-content; }
  .input-kids { min-width: 200px; }
  .input-marbles { min-width: 200px; }
</style>

<div id="app" v-cloak>

  <h1>[[ title ]]</h1>
  <div v-html="main_text"></div>

  <div class="text-center my-3">
    <div class="image">
      <img :src="image_path" :alt="title" :width="500" style="max-width: 600px; width: 100%; height:auto;">
    </div>
  </div>

  <form id="form" @submit.prevent="validate">
    <div class="text-center">
      <ul class="list-group list-group-flush my-3">
        <li class="list-group-item d-flex" v-for="(item, itemIndex) in items" :key="itemIndex" style="flex-flow: nowrap;">
          <div class="input-group mb-3 d-flex align-items-baseline" style="flex-flow: nowrap;">
            <div v-for="(field, fieldIndex) in item.fields" :key="fieldIndex"
                 class="align-items-baseline input-group mb-3 d-flex flex-nowrap">
              <input type="text"
                     v-model.trim="field.value"
                     class="form-control input-kids"
                     :placeholder="`Field ${fieldIndex+1}`"
                     required
                     @input="hideError">
              <span class="input-group-text mx-3 text-nowrap">[[ field.suffix ]]</span>
            </div>

            <button @click.prevent="addItem"
                    type="button"
                    class="btn btn-success"
                    style="flex-basis: 75px;"
                    :disabled="items.length === maxItems">+</button>

            <button @click.prevent="removeItem(itemIndex)"
                    type="button"
                    class="btn btn-danger"
                    style="flex-basis: 75px;"
                    :disabled="items.length === minItems">-</button>
          </div>
        </li>
      </ul>

      <p v-if="error" class="alert alert-danger">[[ errorMessage || 'Error: please, check your answers!' ]]</p>
    </div>

    <button :disabled="!isFormComplete" class="btn btn-primary" type="submit">Next</button>
  </form>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
  data() {
    const s = window.page_settings || {};
    const suffixes = Array.isArray(window.suffixes) ? window.suffixes : [];
    const allowedValues = Array.isArray(window.allowedValues) ? window.allowedValues : [];

    // initial row
    const seedFields = suffixes.map((suffix, i) => ({
      value: '',
      suffix,
      allowedValues: Array.isArray(allowedValues[i]) ? allowedValues[i].map(v => String(v).toLowerCase()) : []
    }));

    // robust image path (prefer sheet-built full URL)
    let image_path = s.full_image_path || s.image_url || '';
    if (!image_path && s.image) {
      const name = (typeof s.image === 'string' && s.image.includes('.')) ? s.image : `${s.image}.png`;
      image_path = `/static/start/practice/${name}`;
    }
    if (!image_path) image_path = 'https://picsum.photos/200/300?text=No+Image';

    return {
      // sheet-driven display
      title: s.title || 'Practice',
      main_text: s.main_text || '',
      image_path,

      // form model
      suffixes,
      items: [{ fields: seedFields }],

      // config
      maxItems: 5,
      minItems: 1,

      // answer key from sheet (array of arrays)
      correct_answers: Array.isArray(s.right_answer) ? s.right_answer : [],

      // ui state
      error: false,
      errorMessage: '',
    };
  },

  computed: {
    isFormFull() {
      return this.items.every(item => item.fields.every(f => f.value !== null && f.value !== undefined && f.value !== ''));
    },
    isFormComplete() {
      // require all filled and same number of rows as the answer key
      return this.isFormFull && this.items.length === (this.correct_answers?.length || 0);
    },
    // array of arrays of user inputs (trimmed, single-spaced)
    flattenValues() {
      return this.items.map(item =>
        item.fields.map(field =>
          String(field.value).trim().replace(/\s+/g, ' ')
        )
      );
    }
  },

  methods: {
    validate() {
      if (!this.isValid()) {
        this.error = true;
        if (!this.isFormFull) this.errorMessage = 'Please fill all fields.';
        else if (this.items.length !== (this.correct_answers?.length || 0)) this.errorMessage = 'Please add/remove rows to match the required number.';
        else this.errorMessage = 'Error';
        return;
      }
      this.error = false;
      document.getElementById('form').submit(); // native submit
    },

    isValid() {
      // normalize both arrays: lower-case + single spaces
      const norm = arr => arr.map(row => row.map(s => String(s).trim().replace(/\s+/g, ' ').toLowerCase()));
      let user = norm(this.flattenValues);
      let key  = norm(this.correct_answers);

      // sort rows and cells to be order-insensitive
      const sort2D = arr => arr.map(row => [...row].sort()).sort((a,b) => a.join('|').localeCompare(b.join('|')));
      user = sort2D(user);
      key  = sort2D(key);

      return JSON.stringify(user) === JSON.stringify(key);
    },

    addItem() {
      if (this.items.length >= this.maxItems) return;
      const fields = this.suffixes.map((suffix, i) => ({
        value: '',
        suffix,
        allowedValues: (Array.isArray(window.allowedValues?.[i]) ? window.allowedValues[i].map(v => String(v).toLowerCase()) : [])
      }));
      this.items.push({ fields });
    },

    removeItem(index) {
      if (this.items.length > this.minItems) this.items.splice(index, 1);
    },

    hideError() { this.error = false; }
  }
});

app.config.compilerOptions.delimiters = ['[[', ']]'];
app.mount('#app');
</script>

{% endblock %}
