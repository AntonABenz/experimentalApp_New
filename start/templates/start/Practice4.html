{% extends "otree/Page.html" %}
{% load otree static %}

{% block content %}

<script>
  window.suffixes      = {{ session.vars.suffixes|json }};
  window.allowedValues = {{ session.vars.allowed_values|json }};
  window.page_settings = {{ settings|json }};
  window.rightAnswers  = {{ settings.right_answer|json }} || [];
</script>

<style>
  [v-cloak] { display: none; }
  .input-group { max-width: fit-content; }
  .input-kids  { min-width: 200px; }

  .placeholder-img {
      width: 600px;
      height: 400px;
      background-color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      margin: 0 auto;
  }

  .clean-row {
      border: none;
      padding: 5px 0;
      margin-bottom: 10px;
  }
</style>

<div id="app" v-cloak>

  <h1>[[ title ]]</h1>
  <div v-html="main_text"></div>

  <div class="text-center my-3">
    <img v-if="image_path" :src="image_path" :alt="title" style="max-width: 600px; width: 100%; height:auto;">
    <div v-else class="placeholder-img">(No Image Available)</div>
  </div>

  <div class="text-center">
    <div v-for="(item, itemIndex) in items" :key="itemIndex" class="clean-row d-flex justify-content-center">
      <div class="input-group mb-3 d-flex align-items-baseline" style="flex-flow: nowrap;">

        <div v-for="(field, fieldIndex) in item.fields"
             :key="fieldIndex"
             class="align-items-baseline input-group mb-3 d-flex flex-nowrap">

          <input
            type="text"
            v-model.trim="field.value"
            class="form-control input-kids"
            :placeholder="`...`"
            autocomplete="off"
            @input="hideError"
          >
          <span class="input-group-text mx-2 text-nowrap" style="background:none; border:none; font-weight:bold;">
            [[ field.suffix ]]
          </span>
        </div>

        <button @click.prevent="addItem" type="button" class="btn btn-outline-secondary ml-2" style="flex-basis: 40px;" :disabled="items.length === maxItems">+</button>
        <button @click.prevent="removeItem(itemIndex)" type="button" class="btn btn-outline-danger ml-1" style="flex-basis: 40px;" :disabled="items.length === minItems">-</button>
      </div>
    </div>

    <p v-if="error" class="alert alert-danger mt-3">
      [[ errorMessage ]]
    </p>
  </div>

  <!-- ✅ IMPORTANT: send to oTree -->
  <input type="hidden" name="practice_response" :value="jsonPayload">

  <div class="text-center mt-4">
    <button :disabled="!isFormFilled" class="btn btn-primary btn-lg" type="button" @click="validateAndSubmit">
      Next
    </button>
  </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
  data() {
    const s           = window.page_settings   || {};
    const suffixes    = Array.isArray(window.suffixes)      ? window.suffixes      : [];
    const allowedVals = Array.isArray(window.allowedValues) ? window.allowedValues : [];
    const requiredRows = Number(s.required_rows) || (window.rightAnswers || []).length || 3;

    const cleanStr = (str) => String(str).toLowerCase().replace(/\s+/g, ' ').trim();

    // normalize correct answers
    const correctAnswers = (window.rightAnswers || []).map(ans =>
      ans.split(';').map(part => cleanStr(part)).join(';')
    );

    const createRow = () => ({
      fields: suffixes.map((suffix, i) => ({
        value: '',
        suffix,
        allowedLower: Array.isArray(allowedVals[i]) ? allowedVals[i].map(v => cleanStr(v)) : []
      }))
    });

    let image_path = s.full_image_path || '';
    return {
      title: s.title || 'Practice Task',
      main_text: s.main_text || '',
      image_path,
      allowedValues: allowedVals,
      suffixes,
      requiredRows,
      correctAnswers,
      items: [createRow()],
      maxItems: 5,
      minItems: 1,
      error: false,
      errorMessage: '',
      cleanStr,
    };
  },

  computed: {
    isFormFilled() {
      return this.items.every(item =>
        item.fields.every(f => f.value && f.value.trim() !== '')
      );
    },
    jsonPayload() {
      // ✅ what server expects for Practice 4/5 validation
      return JSON.stringify(this.items.map(item => item.fields.map(f => f.value)));
    }
  },

  methods: {
    validateAndSubmit() {
      this.error = false;
      this.errorMessage = '';

      // enforce required rows (Practice4 should be 3)
      if (this.items.length !== this.requiredRows) {
        this.error = true;
        this.errorMessage = `You need exactly ${this.requiredRows} sentences (rows). You currently have ${this.items.length}.`;
        return;
      }

      // correct answer check
      if (this.correctAnswers.length > 0) {
        const userStrings = this.items.map(item =>
          item.fields.map(f => this.cleanStr(f.value)).join(';')
        );

        const userSorted = [...userStrings].sort();
        const correctSorted = [...this.correctAnswers].sort();

        for (let i = 0; i < correctSorted.length; i++) {
          if (userSorted[i] !== correctSorted[i]) {
            this.error = true;
            this.errorMessage = "Some answers are incorrect. Please check spelling and values.";
            return;
          }
        }
      }

      const outerForm = document.querySelector('form');
      if (outerForm) outerForm.submit();
    },

    addItem() {
      if (this.items.length >= this.maxItems) return;
      const createRow = () => ({
        fields: this.suffixes.map((suffix, i) => ({
          value: '',
          suffix,
          allowedLower: Array.isArray(this.allowedValues[i]) ? this.allowedValues[i].map(v => this.cleanStr(v)) : []
        }))
      });
      this.items.push(createRow());
    },

    removeItem(index) {
      if (this.items.length > this.minItems) {
        this.items.splice(index, 1);
      }
    },

    hideError() {
      this.error = false;
      this.errorMessage = '';
    }
  }
});

app.config.compilerOptions.delimiters = ['[[', ']]'];
app.mount('#app');
</script>

{% endblock %}
