{% extends "otree/Page.html" %}
{% load otree static %}

{% block content %}
<style>
  [v-cloak] { display: none; }
  .input-group { max-width: fit-content; }
  .input-kids  { min-width: 200px; }
  .clean-row { border: none; padding: 5px 0; margin-bottom: 10px; }
  .vocab-box { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
  .image-box { width: 100%; max-width: 600px; height: auto; min-height: 200px; background-color: #eee; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
</style>

<script>
  window.props = {
    settings: {{ settings|json }},
    allowedValues: {{ allowed_values|json }},
    suffixes: {{ suffixes|json }},
    regexStr: {{ js_regex|safe }}
  };
</script>

<div id="app" v-cloak>
  <h2 class="text-center my-3">[[ props.settings.title ]]</h2>
  <div v-html="props.settings.main_text"></div>

  <div class="text-center my-4">
    <img v-if="props.settings.full_image_path" :src="props.settings.full_image_path" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd;">
    <div v-else class="image-box">No Image</div>
  </div>

  <div class="vocab-box text-center">
    <h5>Allowed Vocabulary</h5>
    <div class="row">
      <div class="col-md-6" v-if="props.allowedValues[0]">
        <div v-for="v in props.allowedValues[0]">[[ v ]]</div>
      </div>
      <div class="col-md-6" v-if="props.allowedValues[1]">
        <div v-for="v in props.allowedValues[1]">[[ v ]]</div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <div v-for="(item, itemIndex) in items" :key="itemIndex" class="clean-row d-flex justify-content-center">
      <div class="input-group mb-3 d-flex align-items-baseline flex-nowrap">
        <div v-for="(field, fieldIndex) in item.fields" :key="fieldIndex" class="d-flex align-items-baseline">
          <input type="text" v-model="field.value" class="form-control input-kids" placeholder="..." autocomplete="off" @input="errorMsg=''">
          <span class="mx-2 font-weight-bold">[[ field.suffix ]]</span>
        </div>
        <button class="btn btn-outline-secondary ml-2" @click.prevent="addItem" :disabled="items.length >= 5">+</button>
        <button class="btn btn-outline-danger ml-1" @click.prevent="removeItem(itemIndex)" :disabled="items.length <= 1">-</button>
      </div>
    </div>
  </div>

  <input type="hidden" name="practice_response" :value="jsonPayload">
  
  <p v-if="errorMsg" class="alert alert-danger text-center mt-3" style="max-width: 600px; margin: 0 auto;">[[ errorMsg ]]</p>

  <div class="text-center mt-5">
    <button class="btn btn-primary btn-lg" @click.prevent="check">Next</button>
  </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
  data() {
    const p = window.props || {};
    let suffixes = p.suffixes || ["", ""];
    const regexList = (p.regexStr || []).map(r => new RegExp(`^${r}$`, 'i'));

    return {
      props: p,
      suffixes,
      regexList,
      items: [{ fields: suffixes.map(s => ({ value: "", suffix: s })) }],
      requiredRows: 5, // Practice 7 requires 5 sentences
      errorMsg: ""
    };
  },
  computed: {
    jsonPayload() { return JSON.stringify(this.items.map(i => i.fields.map(f => f.value))); }
  },
  methods: {
    addItem() { if(this.items.length < 5) this.items.push({ fields: this.suffixes.map(s=>({value:"", suffix:s})) }); },
    removeItem(i) { if(this.items.length > 1) this.items.splice(i, 1); },
    check() {
      this.errorMsg = "";
      
      if (this.items.length !== this.requiredRows) {
        this.errorMsg = `You must produce exactly ${this.requiredRows} sentences.`;
        return;
      }
      for (let i = 0; i < this.items.length; i++) {
        const row = this.items[i];
        for (let j = 0; j < row.fields.length; j++) {
          const val = (row.fields[j].value || "").trim();
          const reg = this.regexList[j];
          if (reg && !reg.test(val)) {
            this.errorMsg = `Sentence ${i+1}, Field ${j+1}: "${val}" is not valid. Please choose from the allowed vocabulary.`;
            return; 
          }
        }
      }
      document.querySelector('form').submit();
    }
  }
});
app.config.compilerOptions.delimiters = ["[[", "]]"];
app.mount("#app");
</script>
{% endblock %}
