{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
    [v-cloak] { display: none; }

    /* Top-right Instructions button */
    .instructions-btn {
        position: fixed;
        top: 14px;
        right: 14px;
        z-index: 3000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        border-radius: 6px;
    }

    /* Small help icon next to inputs */
    .mini-help {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 1px solid #888;
        background: #fff;
        font-weight: 800;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        user-select: none;
        margin: 0 8px;
        flex: 0 0 auto;
    }
    .mini-help:hover { background: #f6f6f6; }

    /* Center layout */
    .wrap {
        max-width: 1100px;
        margin: 0 auto;
    }

    .stimulus {
        text-align: center;
        margin: 18px 0 10px 0;
    }
    .stimulus img {
        max-width: 100%;
        max-height: 520px;
        border: 1px solid #ddd;
        border-radius: 6px;
    }
    .img-fail {
        margin-top: 10px;
        color: #a00;
        font-weight: 600;
    }

    /* Producer input area */
    .sentence-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        margin: 14px 0;
        flex-wrap: wrap;
    }
    .sentence-row .field-box {
        display: flex;
        align-items: center;
        gap: 0;
        margin: 0 4px;
    }
    .sentence-row input.form-control {
        min-width: 260px;
    }
    .suffix {
        margin-left: 8px;
        margin-right: 8px;
        font-weight: 700;
        white-space: nowrap;
    }

    .plusminus {
        display: flex;
        gap: 8px;
        margin-left: 16px;
    }

    /* Interpreter */
    .sentence-card {
        background: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 16px;
        margin: 18px auto;
        max-width: 980px;
        font-size: 1.1rem;
        border-radius: 6px;
    }
    table.buy-table {
        max-width: 980px;
        margin: 0 auto;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        padding: 12px;
    }
    .modal-box {
        background: white;
        width: 96%;
        max-width: 1100px;
        height: 92%;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .modal-header {
        padding: 10px 12px;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }
    .modal-body { flex: 1; overflow: auto; padding: 12px; }
    .help-list {
        max-width: 900px;
        margin: 0 auto;
        font-size: 1rem;
    }
    .help-list ul { margin-bottom: 0; }
    .help-title { font-weight: 800; }
</style>

<script>
window.props = {
    role: "{{ player.inner_role }}",
    suffixes: {{ suffixes|json }},
    allowedValues: {{ allowed_values|json }},
    allowedRegexes: {{ allowed_regexes|json }},
    fullSentences: {{ player.get_full_sentences|json }},
    interpreterChoices: {{ interpreter_choices|json }},
    interpreterTitle: {{ interpreter_title|json }},
    instructionsUrl: {{ instructions_url|json }},
    imageCandidates: {{ image_candidates|json }},
    hasInterpreterField: {{ has_interpreter_field|json }}
};
</script>

<div id="app" v-cloak>
    <!-- Instructions -->
    <button type="button" class="btn btn-success instructions-btn" @click="openInstructions">
        Instructions
    </button>

    <!-- Instructions modal -->
    <div v-if="showInstructions" class="modal-overlay" @click.self="closeInstructions">
        <div class="modal-box">
            <div class="modal-header">
                <div class="help-title">Instructions</div>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn btn-sm btn-secondary" @click="reloadInstructions">Reload</button>
                    <button type="button" class="btn btn-sm btn-danger" @click="closeInstructions">Close</button>
                </div>
            </div>
            <div class="modal-body" style="padding:0;">
                <iframe :src="instructionsSrc" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Field help modal -->
    <div v-if="helpFieldIndex !== null" class="modal-overlay" @click.self="closeFieldHelp">
        <div class="modal-box" style="max-width:900px; height:auto; max-height:90%;">
            <div class="modal-header">
                <div class="help-title">Allowed options</div>
                <button type="button" class="btn btn-sm btn-danger" @click="closeFieldHelp">Close</button>
            </div>
            <div class="modal-body">
                <div class="help-list">
                    <div class="mb-2">
                        <b>Field:</b> [[ helpFieldIndex + 1 ]]
                    </div>
                    <div v-if="(props.allowedValues[helpFieldIndex] || []).length">
                        <ul>
                            <li v-for="(v, idx) in props.allowedValues[helpFieldIndex]" :key="'hv-'+idx">[[ v ]]</li>
                        </ul>
                    </div>
                    <div v-else class="text-muted">
                        No predefined list for this field.
                    </div>

                    <hr>

                    <div>
                        <b>Validation pattern:</b>
                        <div style="font-family: monospace; white-space: pre-wrap;">
                            [[ props.allowedRegexes[helpFieldIndex] || '(none)' ]]
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="wrap">
        {% csrf_token %}

        <!-- PRODUCER -->
        <div v-if="props.role === 'P'">
            <div class="stimulus">
                <img :src="currentImgSrc" @error="handleImgError" alt="stimulus image">
                <div v-if="imgFailed" class="img-fail">
                    Image could not be loaded. Please contact the experimenter.
                </div>
            </div>

            <div class="text-center mt-3 mb-2">
                <h4>Round [[ roundLabel ]]</h4>
            </div>

            <div v-for="(row, rowIdx) in rows" :key="'r-'+rowIdx" class="sentence-row">
                <div v-for="(field, j) in row.fields" :key="'f-'+rowIdx+'-'+j" class="field-box">
                    <input
                        class="form-control"
                        v-model="field.value"
                        :placeholder="placeholders[j] || 'Type here...'"
                        autocomplete="off"
                        :class="{'is-invalid': field.invalid}"
                        @input="validateField(rowIdx, j)"
                    >
                    <div class="mini-help" title="Show allowed options" @click="openFieldHelp(j)">?</div>
                    <span class="suffix">[[ field.suffix ]]</span>
                </div>

                <div class="plusminus">
                    <button type="button" class="btn btn-success" @click="addRow" :disabled="rows.length >= maxRows">+</button>
                    <button type="button" class="btn btn-danger" @click="removeRow(rowIdx)" :disabled="rows.length <= 1">-</button>
                </div>
            </div>

            <input type="hidden" name="producer_decision" :value="producerPayload">
        </div>

        <!-- INTERPRETER -->
        <div v-else>
            <div class="text-center mt-3 mb-2">
                <h4>Round [[ roundLabel ]]</h4>
            </div>

            <h4 class="text-center mb-3">[[ props.interpreterTitle || 'Buy medals:' ]]</h4>

            <div v-if="props.fullSentences.length === 0" class="alert alert-danger text-center">
                Internal error: no sentences received. Please contact the experimenter.
            </div>

            <div v-else class="sentence-card">
                <div v-for="(s, idx) in props.fullSentences" :key="'s-'+idx">[[ s ]]</div>
            </div>

            <h5 class="text-center mb-3">Buy medals:</h5>

            <table class="table table-bordered buy-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th class="text-center">Yes</th>
                        <th class="text-center">No</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(choice, i) in props.interpreterChoices" :key="'c-'+i">
                        <td>[[ choice ]]</td>
                        <td class="text-center">
                            <input type="radio" :name="'row_'+i" value="Yes" v-model="interpRows[i]">
                        </td>
                        <td class="text-center">
                            <input type="radio" :name="'row_'+i" value="No" v-model="interpRows[i]">
                        </td>
                    </tr>
                </tbody>
            </table>

            <input type="hidden" name="interpreter_decision" :value="interpreterPayload">

            {% if has_interpreter_field %}
                {{ formfield_errors 'interpreter_decision' }}
            {% endif %}
        </div>

        <p v-if="errorMsg" class="alert alert-danger text-center mt-3">[[ errorMsg ]]</p>

        <div class="text-center mt-4">
            <button type="button" class="btn btn-primary btn-lg" @click="handleNext">Next</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
    data() {
        const p = window.props || {};
        const suffixes = Array.isArray(p.suffixes) ? p.suffixes : [];
        const nFields = Math.max(1, suffixes.length);

        return {
            props: p,
            maxRows: 5,
            rows: [
                { fields: suffixes.map(s => ({ value: "", suffix: s, invalid: false })) }
            ],
            interpRows: Array.isArray(p.interpreterChoices) ? Array(p.interpreterChoices.length).fill(null) : [],
            errorMsg: "",

            // Instructions modal
            showInstructions: false,
            instructionsNonce: 0,

            // Field help modal
            helpFieldIndex: null,

            // Image fallback
            imgIndex: 0,
            imgFailed: false,

            placeholders: Array(nFields).fill("Type here...")
        };
    },
    computed: {
        roundLabel() {
            // purely cosmetic; your title already shows round/num_rounds
            return "";
        },
        // Only keep COMPLETE rows (no blanks)
        completeRows() {
            const out = [];
            for (const r of this.rows) {
                const vals = r.fields.map(f => String(f.value || "").trim());
                const any = vals.some(v => v.length > 0);
                const all = vals.every(v => v.length > 0);
                if (!any) continue;       // ignore fully empty rows
                if (all) out.push(vals);  // keep only complete rows
            }
            return out;
        },
        producerPayload() {
            return JSON.stringify(this.completeRows);
        },
        interpreterPayload() {
            const choices = Array.isArray(this.props.interpreterChoices) ? this.props.interpreterChoices : [];
            return JSON.stringify(choices.map((choice, i) => ({ choice, answer: this.interpRows[i] })));
        },
        currentImgSrc() {
            const cands = Array.isArray(this.props.imageCandidates) ? this.props.imageCandidates : [];
            if (!cands.length) return "";
            return cands[Math.min(this.imgIndex, cands.length - 1)];
        },
        instructionsSrc() {
            const base = String(this.props.instructionsUrl || "");
            const joiner = base.includes("?") ? "&" : "?";
            return base + joiner + "v=" + this.instructionsNonce;
        }
    },
    methods: {
        openInstructions() {
            this.instructionsNonce += 1;
            this.showInstructions = true;
        },
        closeInstructions() {
            this.showInstructions = false;
        },
        reloadInstructions() {
            this.instructionsNonce += 1;
        },

        openFieldHelp(j) {
            this.helpFieldIndex = j;
        },
        closeFieldHelp() {
            this.helpFieldIndex = null;
        },

        addRow() {
            if (this.rows.length >= this.maxRows) return;
            const suffixes = this.rows[0].fields.map(f => f.suffix);
            this.rows.push({ fields: suffixes.map(s => ({ value: "", suffix: s, invalid: false })) });
        },
        removeRow(i) {
            if (this.rows.length <= 1) return;
            this.rows.splice(i, 1);
        },

        // Regex validation (client side)
        validateField(rowIdx, j) {
            const rx = (Array.isArray(this.props.allowedRegexes) ? this.props.allowedRegexes[j] : "") || "";
            const val = String(this.rows[rowIdx].fields[j].value || "").trim();

            // If empty, don't mark invalid yet (we validate on submit)
            if (!val) {
                this.rows[rowIdx].fields[j].invalid = false;
                return;
            }
            if (!rx) {
                this.rows[rowIdx].fields[j].invalid = false;
                return;
            }
            try {
                const re = new RegExp("^" + rx + "$", "i");
                this.rows[rowIdx].fields[j].invalid = !re.test(val);
            } catch (e) {
                // If regex is malformed, don't block user here; server should catch this.
                this.rows[rowIdx].fields[j].invalid = false;
            }
        },

        handleImgError() {
            const cands = Array.isArray(this.props.imageCandidates) ? this.props.imageCandidates : [];
            if (this.imgIndex + 1 < cands.length) {
                this.imgIndex += 1; // try next extension candidate
                return;
            }
            this.imgFailed = true;
        },

        handleNext() {
            this.errorMsg = "";

            if (this.props.role === "P") {
                // Must have at least one complete row
                if (this.completeRows.length === 0) {
                    this.errorMsg = "Please write at least one complete sentence.";
                    return;
                }

                // Validate ALL complete rows against regex patterns
                const regexes = Array.isArray(this.props.allowedRegexes) ? this.props.allowedRegexes : [];
                for (let r = 0; r < this.completeRows.length; r++) {
                    for (let j = 0; j < this.completeRows[r].length; j++) {
                        const rx = regexes[j] || "";
                        if (!rx) continue;
                        let ok = true;
                        try {
                            const re = new RegExp("^" + rx + "$", "i");
                            ok = re.test(this.completeRows[r][j]);
                        } catch(e) {
                            // if regex broken, let server decide
                            ok = true;
                        }
                        if (!ok) {
                            this.errorMsg = "One of your entries does not match the allowed format. Click the (?) icon to see allowed options.";
                            return;
                        }
                    }
                }
            }

            if (this.props.role === "I") {
                // If no sentences, block submit (otherwise you'll store nonsense rewards)
                if ((this.props.fullSentences || []).length === 0) {
                    this.errorMsg = "Cannot proceed because no sentences were received.";
                    return;
                }
                if (this.interpRows.some(v => !v)) {
                    this.errorMsg = "Please answer Yes/No for every row.";
                    return;
                }
            }

            const outerForm = document.querySelector("form");
            if (outerForm) outerForm.submit();
        }
    }
});
app.config.compilerOptions.delimiters = ["[[", "]]"];
app.mount("#app");
</script>
{% endblock %}
