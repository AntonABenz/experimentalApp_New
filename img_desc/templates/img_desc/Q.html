{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
    [v-cloak] { display: none; }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
    }

    .help-btn {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: 1px solid #999;
        background: #f8f9fa;
        font-weight: 700;
        text-align: center;
        line-height: 30px;
        cursor: pointer;
        user-select: none;
    }

    .input-group { max-width: fit-content; margin: 0 auto; }
    .input-kids { min-width: 200px; }
    .clean-row { margin-bottom: 10px; }

    .vocabulary-box {
        border: 1px solid #ccc;
        background: #f8f9fa;
        padding: 18px;
        border-radius: 6px;
        margin-bottom: 22px;
    }

    .sentence-card {
        background: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 18px;
        margin: 18px auto;
        max-width: 900px;
        font-size: 1.15rem;
        text-align: center;
    }

    table.buy-table {
        max-width: 900px;
        margin: 0 auto;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-box {
        background: white;
        width: 92%;
        max-width: 1000px;
        height: 90%;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 10px;
        text-align: right;
        border-bottom: 1px solid #ddd;
    }

    .modal-body { flex: 1; }
</style>

<script>
window.props = {
    role: "{{ player.inner_role }}",
    allowedValues: {{ allowed_values|json }},
    suffixes: {{ suffixes|json }},
    full_sentences: {{ player.get_full_sentences|json }},
    interpreter_choices: {{ interpreter_choices|json }},
    interpreter_title: {{ interpreter_title|json }},
    instructions_url: "/p/{{ participant.code }}/start/Instructions/1"
};
</script>

<div id="app" v-cloak>

  <div class="page-header">
      <h3>Task</h3>
      <div class="help-btn" @click="showHelp=true">?</div>
  </div>

  <!-- HELP MODAL -->
  <div v-if="showHelp" class="modal-overlay" @click.self="showHelp=false">
      <div class="modal-box">
          <div class="modal-header">
              <button type="button" class="btn btn-sm btn-danger" @click="showHelp=false">Close</button>
          </div>
          <div class="modal-body">
              <iframe :src="props.instructions_url"
                      style="width:100%;height:100%;border:none;"></iframe>
          </div>
      </div>
  </div>

  <!-- ================= PRODUCER ================= -->
  <div v-if="props.role === 'P'">

      <div class="text-center my-4">
          <img src="{{ player.get_image_url }}"
               style="max-width:100%;max-height:520px;border:1px solid #ddd;">
      </div>

      <div class="vocabulary-box text-center">
          <h5>Allowed Vocabulary</h5>
          <div class="row">
              <div class="col-md-6">
                  <div v-for="(v,idx) in props.allowedValues[0]" :key="'av1-'+idx">[[ v ]]</div>
              </div>
              <div class="col-md-6">
                  <div v-for="(v,idx) in props.allowedValues[1]" :key="'av2-'+idx">[[ v ]]</div>
              </div>
          </div>
      </div>

      <div class="text-center">
          <div v-for="(item, i) in items" :key="i" class="clean-row">
              <div class="input-group">
                  <div v-for="(f, j) in item.fields" :key="j" class="d-flex align-items-baseline">
                      <input class="form-control input-kids"
                             v-model="f.value"
                             placeholder="..."
                             autocomplete="off">
                      <span class="mx-2">[[ f.suffix ]]</span>
                  </div>

                  <button type="button"
                          class="btn btn-outline-secondary"
                          @click="addItem"
                          :disabled="items.length>=maxItems">+</button>

                  <button type="button"
                          class="btn btn-outline-danger"
                          @click="removeItem(i)"
                          :disabled="items.length<=1">-</button>
              </div>
          </div>
      </div>

      <input type="hidden" name="producer_decision" :value="producerPayload">

  </div>

  <!-- ================= INTERPRETER ================= -->
  <div v-else>

      <h4 class="text-center mb-3">[[ props.interpreter_title ]]</h4>

      <div v-if="props.full_sentences.length === 0" class="alert alert-danger text-center">
          Internal error: no sentences received. Please contact the experimenter.
      </div>

      <div v-else class="sentence-card">
          <div v-for="(s,idx) in props.full_sentences" :key="'fs-'+idx">[[ s ]]</div>
      </div>

      <h5 class="text-center mb-3">Buy medals:</h5>

      <table class="table table-bordered buy-table">
          <thead>
              <tr>
                  <th>Description</th>
                  <th class="text-center">Yes</th>
                  <th class="text-center">No</th>
              </tr>
          </thead>
          <tbody>
              <tr v-for="(choice,i) in props.interpreter_choices" :key="'ic-'+i">
                  <td>[[ choice ]]</td>
                  <td class="text-center">
                      <input type="radio"
                             :name="'row_'+i"
                             value="Yes"
                             v-model="interpRows[i]">
                  </td>
                  <td class="text-center">
                      <input type="radio"
                             :name="'row_'+i"
                             value="No"
                             v-model="interpRows[i]">
                  </td>
              </tr>
          </tbody>
      </table>

      <input type="hidden" name="interpreter_decision" :value="interpreterPayload">

      <!-- IMPORTANT: this must be server-side conditional, NOT Vue -->
      {% if player.inner_role == 'I' %}
          {{ formfield_errors 'interpreter_decision' }}
      {% endif %}

  </div>

  <p v-if="errorMsg" class="alert alert-danger text-center mt-3">[[ errorMsg ]]</p>

  <div class="text-center mt-4">
      <button type="button" class="btn btn-primary btn-lg" @click="handleNext">Next</button>
  </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
    data() {
        const p = window.props || {};
        const suffixes = Array.isArray(p.suffixes) && p.suffixes.length ? p.suffixes : ["", ""];
        const ic = Array.isArray(p.interpreter_choices) ? p.interpreter_choices : [];

        return {
            props: p,
            items: [{ fields: suffixes.map(s => ({ value: "", suffix: s })) }],
            maxItems: 5,
            interpRows: Array(ic.length).fill(null),
            errorMsg: "",
            showHelp: false
        };
    },
    computed: {
        producerPayload() {
            return JSON.stringify(this.items.map(i => i.fields.map(f => f.value)));
        },
        interpreterPayload() {
            return JSON.stringify(
                (this.props.interpreter_choices || []).map((choice, i) => ({
                    choice,
                    answer: this.interpRows[i]
                }))
            );
        }
    },
    methods: {
        addItem() {
            if (this.items.length >= this.maxItems) return;
            const suffixes = this.items[0].fields.map(f => f.suffix);
            this.items.push({ fields: suffixes.map(s => ({ value: "", suffix: s })) });
        },
        removeItem(i) {
            if (this.items.length <= 1) return;
            this.items.splice(i, 1);
        },
        handleNext() {
            this.errorMsg = "";

            // Interpreter must answer every row
            if (this.props.role === "I") {
                if (this.interpRows.some(v => !v)) {
                    this.errorMsg = "Please answer Yes/No for every row.";
                    return;
                }
            }

            // Producer must write at least 1 complete sentence (optional but recommended)
            if (this.props.role === "P") {
                const completeRows = this.items.filter(row =>
                    row.fields.every(f => String(f.value || "").trim())
                );
                if (completeRows.length === 0) {
                    this.errorMsg = "Please write at least one complete sentence (or remove empty rows).";
                    return;
                }
            }

            const outerForm = document.querySelector("form");
            if (outerForm) outerForm.submit();
        }
    }
});
app.config.compilerOptions.delimiters = ["[[", "]]"];
app.mount("#app");
</script>
{% endblock %}
