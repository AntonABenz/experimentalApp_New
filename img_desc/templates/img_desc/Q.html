{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
  [v-cloak] { display: none; }

  /* Help icon */
  .help-link {
    position: fixed;
    top: 18px;
    right: 18px;
    width: 38px;
    height: 38px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-weight: 700;
    font-size: 18px;
    color: #333;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    z-index: 9999;
  }
  .help-link:hover { background: #f7f7f7; }

  /* PRODUCER STYLES */
  .input-group { max-width: fit-content; margin: 0 auto; }
  .input-kids  { min-width: 200px; }

  .vocabulary-box {
    border: 1px solid #ccc;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 25px;
  }

  .vocab-column { font-size: 1.1rem; line-height: 1.6; text-align: left; }

  @media (min-width: 768px) {
    .vocab-column:first-child { border-right: 2px solid #e9ecef; }
  }

  .clean-row { border: none; padding: 5px 0; margin-bottom: 10px; }

  /* INTERPRETER STYLES */
  .sentence-card {
    background: #e3f2fd;
    border-left: 5px solid #2196f3;
    padding: 20px;
    margin: 20px 0;
    font-size: 1.1rem;
    text-align: center;
  }

  .choice-table {
    max-width: 800px;
    margin: 0 auto;
  }

  .error-box {
    max-width: 800px;
    margin: 14px auto 0;
  }
</style>

<!-- Top-right help link -->
<a class="help-link"
   href="/p/{{ participant.code }}/start/Instructions/1"
   title="Instructions"
   target="_blank"
   rel="noopener">?</a>


<script>
  window.props = {
    role: "{{ player.role }}",
    allowedValues: {{ allowed_values|json }},
    suffixes: {{ suffixes|json }},
    full_sentences: {{ player.get_full_sentences|json }},
    interpreter_choices: {{ session.vars.interpreter_choices|json }},
    interpreter_title: "{{ session.vars.interpreter_title }}"
  };
</script>

<div id="app" v-cloak>

  <!-- PRODUCER -->
  <div v-if="props.role === 'P'">

    <div class="text-center my-4">
      <img src="{{ player.get_image_url }}"
           style="max-width: 100%; height: auto; max-height: 500px; border:1px solid #ddd; padding:5px;">
    </div>

    <div class="vocabulary-box text-center">
      <h5 class="mb-4">Allowed Vocabulary</h5>
      <div class="row justify-content-center">
        <div class="col-md-5 vocab-column px-4">
          <div v-if="props.allowedValues[0]">
            <span v-for="(val, idx) in props.allowedValues[0]" :key="idx">
              [[ val ]]<span v-if="idx < props.allowedValues[0].length - 1">; </span>
            </span>
          </div>
        </div>
        <div class="col-md-5 vocab-column px-4">
          <div v-if="props.allowedValues[1]">
            <span v-for="(val, idx) in props.allowedValues[1]" :key="idx">
              [[ val ]]<span v-if="idx < props.allowedValues[1].length - 1">; </span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <div v-for="(item, itemIndex) in items" :key="itemIndex" class="clean-row d-flex justify-content-center">
        <div class="input-group mb-3 d-flex align-items-baseline flex-nowrap">
          <div v-for="(field, fieldIndex) in item.fields" :key="fieldIndex" class="d-flex align-items-baseline">
            <input type="text" v-model="field.value" class="form-control input-kids" placeholder="..." autocomplete="off">
            <span class="mx-2 font-weight-bold">[[ field.suffix ]]</span>
          </div>
          <button @click.prevent="addItem" type="button" class="btn btn-outline-secondary ml-2" :disabled="items.length >= 5">+</button>
          <button @click.prevent="removeItem(itemIndex)" type="button" class="btn btn-outline-danger ml-1" :disabled="items.length <= 1">-</button>
        </div>
      </div>
    </div>

    <input type="hidden" name="producer_decision" :value="producerJson">

  </div>

  <!-- INTERPRETER -->
  <div v-else-if="props.role === 'I'">

    <h3 class="text-center">[[ props.interpreter_title || 'Your Partner Wrote:' ]]</h3>

    <div class="sentence-card">
      <div v-if="props.full_sentences.length === 0">
        <em>(Your partner did not produce any sentences)</em>
      </div>
      <div v-for="s in props.full_sentences" :key="s">
        [[ s ]]
      </div>
    </div>

    <!-- Practice-1 style Yes/No table -->
    <div class="choice-table mt-4">
      <table class="table">
        <thead>
          <tr>
            <th>[[ props.interpreter_title || 'Buy medals' ]]</th>
            <th class="text-center">Yes</th>
            <th class="text-center">No</th>
          </tr>
        </thead>

        <tbody>
          <tr v-for="(row, idx) in interpRows" :key="idx">
            <td>[[ row.name ]]</td>
            <td class="text-center">
              <input type="radio"
                     :name="'row_'+idx"
                     :value="true"
                     v-model="row.choice">
            </td>
            <td class="text-center">
              <input type="radio"
                     :name="'row_'+idx"
                     :value="false"
                     v-model="row.choice">
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- hidden oTree field -->
    <input type="hidden" name="interpreter_decision" :value="interpreterJson">

    <div v-if="errorMsg" class="alert alert-danger error-box">
      [[ errorMsg ]]
    </div>

  </div>

  <!-- NEXT -->
  <div class="text-center mt-5">
    <button type="button" class="btn btn-primary btn-lg" @click.prevent="nextPage">
      Next
    </button>
  </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
  const app = Vue.createApp({
    data() {
      const p = window.props || {};
      let suffixes = p.suffixes;
      if (!suffixes || suffixes.length === 0) suffixes = ["", ""];

      return {
        props: p,
        errorMsg: "",

        // Producer UI state
        items: [{ fields: suffixes.map(s => ({ value: "", suffix: s })) }],

        // Interpreter table state
        interpRows: (p.interpreter_choices || []).map(label => ({
          name: label,
          choice: null
        })),
      };
    },

    computed: {
      producerJson() {
        return JSON.stringify(this.items.map(item => item.fields.map(f => f.value)));
      },

      interpreterJson() {
        // store as [true/false, true/false, ...] in JSON
        return JSON.stringify(this.interpRows.map(r => r.choice));
      },

      interpreterAllChosen() {
        return this.interpRows.every(r => r.choice !== null);
      }
    },

    methods: {
      addItem() {
        if (this.items.length < 5) {
          this.items.push({ fields: this.props.suffixes.map(s => ({ value: "", suffix: s })) });
        }
      },

      removeItem(index) {
        if (this.items.length > 1) this.items.splice(index, 1);
      },

      nextPage() {
        this.errorMsg = "";

        // Only validate interpreter table for interpreter role
        if (this.props.role === "I") {
          if (!this.interpreterAllChosen) {
            this.errorMsg = "Please select Yes/No for every row before continuing.";
            return;
          }
        }

        // submit outer oTree form
        const outerForm = document.querySelector("form");
        if (outerForm) outerForm.submit();
      }
    }
  });

  app.config.compilerOptions.delimiters = ["[[", "]]"];
  app.mount("#app");
</script>

{% endblock %}
