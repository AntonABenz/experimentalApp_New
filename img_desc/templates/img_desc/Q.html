{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
    [v-cloak] { display: none; }

    /* Header + help */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .help-btn {
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #999;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        text-align: center;
        line-height: 28px;
        background: #f8f9fa;
    }

    /* Producer */
    .input-group { max-width: fit-content; margin: 0 auto; }
    .input-kids  { min-width: 200px; }

    .vocabulary-box {
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 25px;
    }

    .clean-row { margin-bottom: 10px; }

    /* Interpreter */
    table { max-width: 700px; margin: 0 auto; }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-box {
        background: #fff;
        width: 90%;
        max-width: 900px;
        height: 90%;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 10px;
        text-align: right;
        border-bottom: 1px solid #ccc;
    }

    .modal-body {
        flex: 1;
    }
</style>

<script>
window.props = {
    role: "{{ player.role }}",
    allowedValues: {{ allowed_values|json }},
    suffixes: {{ suffixes|json }},
    full_sentences: {{ player.get_full_sentences|json }},
    interpreter_choices: {{ session.vars.interpreter_choices|json }},
    interpreter_title: "{{ session.vars.interpreter_title }}"
};
</script>

<div id="app" v-cloak>

    <!-- HEADER -->
    <div class="page-header mb-3">
        <h3>Task</h3>
        <div class="help-btn" @click="showHelp = true">?</div>
    </div>

    <!-- HELP MODAL -->
    <div v-if="showHelp" class="modal-overlay" @click.self="showHelp=false">
        <div class="modal-box">
            <div class="modal-header">
                <button class="btn btn-sm btn-danger" @click="showHelp=false">Close</button>
            </div>
            <div class="modal-body">
                <iframe
                    src="/p/{{ participant.code }}/start/Instructions/1"
                    style="width:100%; height:100%; border:none;">
                </iframe>
            </div>
        </div>
    </div>

    <!-- ================= PRODUCER ================= -->
    <div v-if="props.role === 'P'">

        <div class="text-center my-4">
            <img src="{{ player.get_image_url }}"
                 style="max-width:100%; max-height:500px; border:1px solid #ddd;">
        </div>

        <div class="vocabulary-box text-center">
            <h5>Allowed Vocabulary</h5>
            <div class="row">
                <div class="col-md-6">
                    <div v-for="v in props.allowedValues[0]">[[ v ]]</div>
                </div>
                <div class="col-md-6">
                    <div v-for="v in props.allowedValues[1]">[[ v ]]</div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <div v-for="(item, idx) in items" :key="idx" class="clean-row">
                <div class="input-group">
                    <div v-for="(f, j) in item.fields" :key="j" class="d-flex">
                        <input class="form-control input-kids"
                               v-model="f.value"
                               placeholder="...">
                        <span class="mx-2">[[ f.suffix ]]</span>
                    </div>
                    <button class="btn btn-outline-secondary"
                            @click.prevent="addItem"
                            :disabled="items.length >= 5">+</button>
                    <button class="btn btn-outline-danger"
                            @click.prevent="removeItem(idx)"
                            :disabled="items.length <= 1">-</button>
                </div>
            </div>
        </div>

        <input type="hidden" name="producer_decision" :value="jsonPayload">

    </div>

    <!-- ================= INTERPRETER ================= -->
    <div v-else>

        <h4 class="text-center mb-3">
            [[ props.interpreter_title || 'Buy medals' ]]
        </h4>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Yes</th>
                    <th>No</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(s, i) in props.full_sentences" :key="i">
                    <td>[[ s ]]</td>
                    <td><input type="radio" :name="'interp_'+i" value="Yes" required></td>
                    <td><input type="radio" :name="'interp_'+i" value="No" required></td>
                </tr>
            </tbody>
        </table>

    </div>

    <!-- ERROR -->
    <p v-if="errorMsg" class="alert alert-danger text-center mt-3">
        [[ errorMsg ]]
    </p>

    <!-- NEXT -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg" @click="handleNext">Next</button>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
    data() {
        const p = window.props;
        let suffixes = p.suffixes || ["",""];
        return {
            props: p,
            items: [{ fields: suffixes.map(s => ({ value:"", suffix:s })) }],
            showHelp: false,
            errorMsg: ""
        };
    },
    computed: {
        jsonPayload() {
            return JSON.stringify(
                this.items.map(i => i.fields.map(f => f.value))
            );
        }
    },
    methods: {
        addItem() {
            if (this.items.length < 5) {
                this.items.push({
                    fields: this.props.suffixes.map(s => ({ value:"", suffix:s }))
                });
            }
        },
        removeItem(i) {
            if (this.items.length > 1) this.items.splice(i,1);
        },
        handleNext() {
            this.errorMsg = "";

            if (this.props.role === "P") {
                const firstComplete =
                    this.items[0].fields.every(f => f.value.trim());
                if (!firstComplete) {
                    this.errorMsg = "Please write at least one complete sentence.";
                    return;
                }

                const partial = this.items.some(row => {
                    const vals = row.fields.map(f => f.value.trim());
                    return vals.some(v => v) && !vals.every(v => v);
                });
                if (partial) {
                    this.errorMsg = "Please complete or remove partial sentences.";
                    return;
                }
            }

            document.querySelector("form").submit();
        }
    }
});
app.config.compilerOptions.delimiters = ["[[", "]]"];
app.mount("#app");
</script>

{% endblock %}
