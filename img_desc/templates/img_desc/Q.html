{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
    [v-cloak] { display: none; }

    /* Top-right Instructions button */
    .help-fab {
        position: fixed;
        top: 14px;
        right: 14px;
        border-radius: 999px;
        border: 1px solid #999;
        background: #ffffff;
        font-weight: 700;
        font-size: 14px;
        padding: 8px 12px;
        cursor: pointer;
        z-index: 3000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        user-select: none;
    }
    .help-fab:hover { background: #f6f6f6; }

    /* Modal overlay */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        padding: 12px;
    }
    .modal-box {
        background: white;
        width: 96%;
        max-width: 1100px;
        height: 92%;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .modal-header {
        padding: 10px 12px;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }
    .modal-body { flex: 1; }

    /* Producer */
    .input-group { max-width: 980px; margin: 0 auto; }
    .clean-row { margin-bottom: 14px; }

    .field-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .input-kids {
        min-width: 260px;
        max-width: 420px;
    }

    /* little help icon after input */
    .field-help {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #999;
        background: #fff;
        font-weight: 800;
        line-height: 26px;
        text-align: center;
        cursor: pointer;
        user-select: none;
        flex: 0 0 auto;
    }
    .field-help:hover { background: #f6f6f6; }

    /* Interpreter */
    .sentence-card {
        background: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 18px;
        margin: 18px auto;
        max-width: 900px;
        font-size: 1.15rem;
        text-align: center;
    }
    table.buy-table {
        max-width: 900px;
        margin: 0 auto;
    }
</style>

<script>
window.props = {
    role: "{{ player.inner_role }}",
    suffixes: {{ suffixes|json }},
    prefix: {{ prefix|json }},
    full_sentences: {{ player.get_full_sentences|json }},
    interpreter_choices: {{ interpreter_choices|json }},
    interpreter_title: {{ interpreter_title|json }},
    instructions_url: {{ instructions_url|json }},
    allowed_values: {{ allowed_values|json }},
    allowed_regexes: {{ allowed_regexes|json }},
    caseflag: {{ caseflag|json }},
    server_image_url: "{{ player.get_image_url }}"
};
</script>

<div id="app" v-cloak>

    <!-- Top-right instructions -->
    <div class="help-fab" title="Instructions" @click="openInstructions">
        Instructions
    </div>

    <!-- Instructions modal -->
    <div v-if="showInstructions" class="modal-overlay" @click.self="closeInstructions">
        <div class="modal-box">
            <div class="modal-header">
                <div style="font-weight:700;">Instructions</div>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn btn-sm btn-secondary" @click="reloadInstructions">Reload</button>
                    <button type="button" class="btn btn-sm btn-danger" @click="closeInstructions">Close</button>
                </div>
            </div>
            <div class="modal-body">
                <iframe :src="instructionsSrc" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Per-field options modal -->
    <div v-if="showFieldHelp" class="modal-overlay" @click.self="closeFieldHelp">
        <div class="modal-box" style="max-width:760px; height:auto; max-height:86%;">
            <div class="modal-header">
                <div style="font-weight:700;">
                    Options for field [[ optionsFieldNumber ]]
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn btn-sm btn-danger" @click="closeFieldHelp">Close</button>
                </div>
            </div>
            <div class="modal-body" style="padding:14px; overflow:auto;">
                <div v-if="optionsList.length === 0" class="alert alert-warning">
                    No option list provided for this field.
                </div>
                <ul v-else style="margin:0; padding-left: 20px;">
                    <li v-for="(opt, idx) in optionsList" :key="'opt-'+idx">[[ opt ]]</li>
                </ul>
                <div v-if="currentRegex" style="margin-top:12px; font-size: 0.9rem; color:#444;">
                    <div><b>Validation pattern:</b></div>
                    <div style="font-family: monospace; white-space: pre-wrap;">[[ currentRegex ]]</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODUCER -->
    <div v-if="props.role === 'P'">

        <div class="text-center my-4">
            <img v-if="props.server_image_url"
                 :src="props.server_image_url"
                 style="max-width:100%; max-height:520px; border:1px solid #ddd;"
                 @error="imageError=true">
            <div v-else class="alert alert-warning" style="max-width:900px; margin:0 auto;">
                Image unavailable for this round.
            </div>
            <div v-if="imageError" class="alert alert-danger" style="max-width:900px; margin:12px auto 0;">
                The image failed to load. Please continue and report the round number to the experimenter.
            </div>
        </div>

        <div class="text-center">
            <div v-for="(item, i) in items" :key="'row-'+i" class="clean-row">
                <div class="input-group">

                    <div v-for="(f, j) in item.fields" :key="'f-'+i+'-'+j" class="field-row">

                        <!-- TEXT input with regex validation -->
                        <input class="form-control input-kids"
                               v-model="f.value"
                               :placeholder="'Type here...'"
                               autocomplete="off"
                               :data-field-index="j"
                               @blur="validateField(i,j)"
                        >

                        <!-- HELP icon at end of input -->
                        <div class="field-help"
                             title="Show options"
                             @click="openFieldHelp(j)">
                            ?
                        </div>

                        <span class="mx-2 font-weight-bold">[[ f.suffix ]]</span>

                    </div>

                    <button type="button"
                            class="btn btn-outline-secondary ml-2"
                            @click="addItem"
                            :disabled="items.length>=maxItems">+</button>

                    <button type="button"
                            class="btn btn-outline-danger ml-1"
                            @click="removeItem(i)"
                            :disabled="items.length<=1">-</button>
                </div>
            </div>
        </div>

        <input type="hidden" name="producer_decision" :value="producerPayload">

    </div>

    <!-- INTERPRETER -->
    <div v-else>

        <h4 class="text-center mb-3">[[ props.interpreter_title ]]</h4>

        <div v-if="props.full_sentences.length === 0" class="alert alert-danger text-center">
            Internal error: no sentences received. Please contact the experimenter.
        </div>

        <div v-else class="sentence-card">
            <div v-for="(s,idx) in props.full_sentences" :key="'fs-'+idx">[[ s ]]</div>
        </div>

        <h5 class="text-center mb-3">Buy medals:</h5>

        <table class="table table-bordered buy-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th class="text-center">Yes</th>
                    <th class="text-center">No</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(choice,i) in props.interpreter_choices" :key="'ic-'+i">
                    <td>[[ choice ]]</td>
                    <td class="text-center">
                        <input type="radio" :name="'row_'+i" value="Yes" v-model="interpRows[i]">
                    </td>
                    <td class="text-center">
                        <input type="radio" :name="'row_'+i" value="No" v-model="interpRows[i]">
                    </td>
                </tr>
            </tbody>
        </table>

        <input type="hidden" name="interpreter_decision" :value="interpreterPayload">

        {% if player.inner_role == 'I' %}
            {{ formfield_errors 'interpreter_decision' }}
        {% endif %}
    </div>

    <p v-if="errorMsg" class="alert alert-danger text-center mt-3">[[ errorMsg ]]</p>

    <div class="text-center mt-4">
        <button type="button" class="btn btn-primary btn-lg" @click="handleNext">Next</button>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
    data() {
        const p = window.props || {};
        const suffixes = Array.isArray(p.suffixes) && p.suffixes.length ? p.suffixes : ["", ""];
        const ic = Array.isArray(p.interpreter_choices) ? p.interpreter_choices : [];

        return {
            props: p,
            items: [{ fields: suffixes.map(s => ({ value: "", suffix: s })) }],
            maxItems: 5,
            interpRows: Array(ic.length).fill(null),
            errorMsg: "",
            showInstructions: false,
            instrNonce: 0,

            showFieldHelp: false,
            optionsFieldIndex: 0,

            imageError: false,
        };
    },
    computed: {
        producerPayload() {
            return JSON.stringify(this.items.map(i => i.fields.map(f => (f.value ?? ""))));
        },
        interpreterPayload() {
            return JSON.stringify(
                (this.props.interpreter_choices || []).map((choice, i) => ({
                    choice,
                    answer: this.interpRows[i]
                }))
            );
        },
        instructionsSrc() {
            const base = String(this.props.instructions_url || "");
            const joiner = base.includes("?") ? "&" : "?";
            return base + joiner + "v=" + this.instrNonce;
        },
        optionsList() {
            const av = Array.isArray(this.props.allowed_values) ? this.props.allowed_values : [];
            const vals = av[this.optionsFieldIndex] || [];
            return (vals || []).map(x => String(x));
        },
        currentRegex() {
            const ar = Array.isArray(this.props.allowed_regexes) ? this.props.allowed_regexes : [];
            return ar[this.optionsFieldIndex] ? String(ar[this.optionsFieldIndex]) : "";
        },
        optionsFieldNumber() {
            return this.optionsFieldIndex + 1;
        }
    },
    methods: {
        openInstructions() { this.instrNonce += 1; this.showInstructions = true; },
        closeInstructions() { this.showInstructions = false; },
        reloadInstructions() { this.instrNonce += 1; },

        openFieldHelp(fieldIndex) {
            this.optionsFieldIndex = fieldIndex;
            this.showFieldHelp = true;
        },
        closeFieldHelp() {
            this.showFieldHelp = false;
        },

        addItem() {
            if (this.items.length >= this.maxItems) return;
            const suffixes = this.items[0].fields.map(f => f.suffix);
            this.items.push({ fields: suffixes.map(s => ({ value: "", suffix: s })) });
        },
        removeItem(i) {
            if (this.items.length <= 1) return;
            this.items.splice(i, 1);
        },

        // regex validation per field
        validateField(i, j) {
            const raw = String(this.items[i].fields[j].value ?? "").trim();
            const patt = (Array.isArray(this.props.allowed_regexes) ? this.props.allowed_regexes[j] : "") || "";
            if (!patt) return true; // no regex supplied -> allow

            try {
                const flags = this.props.caseflag ? "i" : "";
                const re = new RegExp("^" + patt + "$", flags);
                const ok = re.test(raw);
                if (!ok) {
                    this.errorMsg = `Field ${j+1} is not in the allowed format. Click the ? icon for examples.`;
                }
                return ok;
            } catch (e) {
                // if regex itself is malformed, don't block participants
                console.warn("Bad regex:", patt, e);
                return true;
            }
        },

        handleNext() {
            this.errorMsg = "";

            if (this.props.role === "I") {
                if (this.interpRows.some(v => !v)) {
                    this.errorMsg = "Please answer Yes/No for every row.";
                    return;
                }
            }

            if (this.props.role === "P") {
                // all fields filled?
                const allFilled = this.items.every(row =>
                    row.fields.every(f => String(f.value || "").trim() !== "")
                );
                if (!allFilled) {
                    this.errorMsg = "Please fill in all fields.";
                    return;
                }

                // all fields match regex?
                for (let i=0; i<this.items.length; i++) {
                    for (let j=0; j<this.items[i].fields.length; j++) {
                        if (!this.validateField(i,j)) return;
                    }
                }

                // confirm submit (Antonâ€™s point #1)
                const ok = window.confirm("Submit your description now? You cannot edit after continuing.");
                if (!ok) return;
            }

            const outerForm = document.querySelector("form");
            if (outerForm) outerForm.submit();
        }
    }
});
app.config.compilerOptions.delimiters = ["[[", "]]"];
app.mount("#app");
</script>
{% endblock %}
