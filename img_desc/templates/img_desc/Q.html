{% extends "otree/Page.html" %}
{% load otree static %}

{% block title %}
Round {{ player.round_number }} / {{ Constants.num_rounds }}
{% endblock %}

{% block content %}
<style>
  [v-cloak] { display: none; }

  /* ---------- TOP RIGHT HELP ICON ---------- */
  .help-btn {
    position: fixed;
    top: 15px;
    right: 20px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #0d6efd;
    color: #fff;
    font-weight: bold;
    font-size: 20px;
    border: none;
    cursor: pointer;
    z-index: 1000;
  }

  /* ---------- MODAL ---------- */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .modal-box {
    background: #fff;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 25px;
    border-radius: 8px;
  }

  /* ---------- PRODUCER ---------- */
  .input-group { max-width: fit-content; margin: 0 auto; }
  .input-kids  { min-width: 200px; }

  .vocabulary-box {
    border: 1px solid #ccc;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 25px;
  }

  .vocab-column { font-size: 1.1rem; line-height: 1.6; text-align: left; }

  @media (min-width: 768px) {
    .vocab-column:first-child { border-right: 2px solid #e9ecef; }
  }

  .clean-row { margin-bottom: 10px; }

  /* ---------- INTERPRETER YES / NO TABLE ---------- */
  table {
    margin: 30px auto;
    width: auto;
  }

  th, td {
    padding: 12px 18px;
    text-align: center;
  }

  .sentence-card {
    background: #e3f2fd;
    border-left: 5px solid #2196f3;
    padding: 20px;
    margin: 25px auto;
    max-width: 800px;
    font-size: 1.2rem;
  }
</style>

<script>
  window.props = {
    role: "{{ player.role }}",
    allowedValues: {{ allowed_values|json }},
    suffixes: {{ suffixes|json }},
    full_sentences: {{ player.get_full_sentences|json }},
    interpreter_choices: {{ session.vars.interpreter_choices|json }},
    interpreter_title: "{{ session.vars.interpreter_title }}"
  };
</script>

<div id="app" v-cloak>

  <!-- HELP BUTTON -->
  <button class="help-btn" @click="openHelp">?</button>

  <!-- HELP MODAL -->
  <div v-if="showHelp" class="modal-overlay" @click.self="showHelp=false">
    <div class="modal-box">
      <div v-html="helpHtml"></div>
      <div class="text-center mt-4">
        <button class="btn btn-secondary" @click="showHelp=false">Close</button>
      </div>
    </div>
  </div>

  <!-- ================= PRODUCER ================= -->
  <div v-if="props.role === 'P'">

    <div class="text-center my-4">
      <img src="{{ player.get_image_url }}"
           style="max-width:100%; max-height:500px; border:1px solid #ddd;">
    </div>

    <div class="vocabulary-box text-center">
      <h5 class="mb-3">Allowed Vocabulary</h5>
      <div class="row justify-content-center">
        <div class="col-md-5 vocab-column px-4">
          <div v-for="v in props.allowedValues[0]">[[ v ]]</div>
        </div>
        <div class="col-md-5 vocab-column px-4">
          <div v-for="v in props.allowedValues[1]">[[ v ]]</div>
        </div>
      </div>
    </div>

    <div v-for="(item,i) in items" :key="i" class="clean-row d-flex justify-content-center">
      <div class="input-group">
        <div v-for="(f,j) in item.fields" :key="j" class="d-flex align-items-center">
          <input v-model="f.value" class="form-control input-kids" autocomplete="off">
          <span class="mx-2 font-weight-bold">[[ f.suffix ]]</span>
        </div>
        <button type="button" class="btn btn-outline-secondary ml-2"
                @click="addItem" :disabled="items.length>=5">+</button>
        <button type="button" class="btn btn-outline-danger ml-1"
                @click="removeItem(i)" :disabled="items.length<=1">-</button>
      </div>
    </div>

    <input type="hidden" name="producer_decision" :value="jsonPayload">

  </div>

  <!-- ================= INTERPRETER ================= -->
  <div v-else>

    <h3 class="text-center mb-3">[[ props.interpreter_title ]]</h3>

    <div class="sentence-card">
      <div v-for="s in props.full_sentences">[[ s ]]</div>
    </div>

    <!-- YES / NO TABLE -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Description</th>
          <th>Yes</th>
          <th>No</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(choice,i) in props.interpreter_choices" :key="i">
          <td>[[ choice ]]</td>
          <td><input type="radio" name="interpreter_decision" :value="choice + ':Yes'" required></td>
          <td><input type="radio" name="interpreter_decision" :value="choice + ':No'" required></td>
        </tr>
      </tbody>
    </table>

  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary btn-lg">Next</button>
  </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const app = Vue.createApp({
  data() {
    const p = window.props;
    let s = p.suffixes?.length ? p.suffixes : ["",""];
    return {
      props: p,
      items: [{ fields: s.map(x => ({ value:"", suffix:x })) }],
      showHelp: false,
      helpHtml: ""
    };
  },
  computed: {
    jsonPayload() {
      return JSON.stringify(this.items.map(i => i.fields.map(f => f.value)));
    }
  },
  methods: {
    addItem() {
      if (this.items.length < 5)
        this.items.push({ fields: this.props.suffixes.map(s => ({ value:"", suffix:s }))});
    },
    removeItem(i) {
      if (this.items.length > 1) this.items.splice(i,1);
    },
    openHelp() {
      fetch("/p/{{ participant.code }}/start/Instructions/1")
        .then(r => r.text())
        .then(html => {
          this.helpHtml = html;
          this.showHelp = true;
        });
    }
  }
});
app.config.compilerOptions.delimiters = ["[[","]]"];
app.mount("#app");
</script>

{% endblock %}
